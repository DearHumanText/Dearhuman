<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tell us the details</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f1623;
      --panel: #121b2a;
      --muted: #9fb0c8;
      --text: #eaf2ff;
      --accent: #6ea8ff;
      --accent-2: #89f7fe;
      --border: #21304a;
      --danger: #ff7777;
      --ok: #55d39a;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 30% -10%, #18243a, #0b1220 60%), var(--bg);
      color: var(--text);
    }
    .wrap {
      max-width: 920px;
      margin: 40px auto;
      padding: 0 20px;
    }
    .card {
      background: linear-gradient(180deg, #121b2a, #0d1524);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 26px;
      box-shadow: 0 10px 40px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.02);
    }
    .topline {
      display: inline-flex;
      gap: 8px;
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      color: var(--muted);
      font-size: 12.5px;
      margin-bottom: 14px;
      background: #0d1524;
    }
    h1 {
      margin: 0 0 6px;
      font-size: 34px;
      letter-spacing: .2px;
    }
    .sub {
      margin: 0 0 22px;
      color: var(--muted);
    }
    label {
      display: block;
      font-weight: 600;
      margin: 18px 0 8px;
    }
    input[type="text"], select, textarea {
      width: 100%;
      background: #0d1524;
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 10px;
      padding: 12px 13px;
      font-size: 15px;
      outline: none;
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    input[type="text"]:focus, select:focus, textarea:focus {
      border-color: #2a71ff;
      box-shadow: 0 0 0 3px rgba(46,127,255,.18);
    }
    textarea { min-height: 150px; resize: vertical; line-height: 1.4; }
    .row {
      display: grid;
      grid-template-columns: 1fr 260px;
      gap: 18px;
    }
    @media (max-width: 820px) {
      .row { grid-template-columns: 1fr; }
    }
    .btns {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 18px;
    }
    button {
      background: linear-gradient(180deg, #2a71ff, #2159cc);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 11px 16px;
      font-weight: 600;
      letter-spacing: .2px;
      cursor: pointer;
      transition: transform .04s ease, filter .12s ease, opacity .12s ease;
    }
    button.secondary {
      background: #19243a;
      border: 1px solid var(--border);
      color: var(--text);
    }
    button:active { transform: translateY(1px); }
    button[disabled] { opacity: .6; cursor: progress; }

    .hint { color: var(--muted); font-size: 13px; margin-top: 4px; }

    .output {
      background: #0b1220;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      margin-top: 12px;
    }

    .ok { color: var(--ok); }
    .err { color: var(--danger); }
    .status { margin-top: 6px; font-size: 13px; min-height: 18px; }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #0e1a2e;
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 12px;
      margin-left: 6px;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topline">
        <span id="planPill">Plan: <strong>Basic</strong></span>
        <span class="pill" id="revPill" style="display:none;">unlimited revisions</span>
      </div>
      <h1>Tell us the details</h1>
      <p class="sub">We’ll generate your message instantly based on your plan.</p>

      <div class="row">
        <div>
          <label for="message_for">Who is this message for?</label>
          <input id="message_for" type="text" placeholder="e.g., my ex, my manager, my friend" />

          <label for="goal">What outcome are you hoping for?</label>
          <input id="goal" type="text" placeholder="e.g., reconnect, apologize, set a boundary" />

          <label for="what_to_say">What do you want to say?</label>
          <textarea id="what_to_say" placeholder="Give context. What happened? What do you want to express?"></textarea>

          <label for="revision_note">Revision note (optional)</label>
          <input id="revision_note" type="text" placeholder="What should we change or emphasize?" />
        </div>

        <div>
          <label for="tone">Tone</label>
          <select id="tone">
            <option value="Compassionate">Compassionate</option>
            <option value="Direct">Direct</option>
            <option value="Friendly">Friendly</option>
            <option value="Professional" selected>Professional</option>
            <option value="Apologetic">Apologetic</option>
          </select>

          <div class="btns">
            <button id="generateBtn">Generate</button>
            <button id="copyBtn" class="secondary" type="button">Copy</button>
          </div>

          <div id="status" class="status"></div>

          <label style="margin-top:18px;">Your message</label>
          <div class="output">
            <textarea id="output" readonly style="min-height:180px;"></textarea>
            <div class="hint">Tip: You can tweak and regenerate as needed.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ---- UI wiring ----
  const copyBtn = document.getElementById('copyBtn');
  const generateBtn = document.getElementById('generateBtn');
  const outEl = document.getElementById('output');
  const statusEl = document.getElementById('status');
  const planPill = document.getElementById('planPill');
  const revPill = document.getElementById('revPill');

  // read ?plan= from URL (default basic)
  const params = new URLSearchParams(location.search);
  const plan = (params.get('plan') || 'basic').toLowerCase();

  // reflect plan in UI
  const planName = { basic: 'Basic', premium: 'Premium', unlimited: 'Unlimited' }[plan] || 'Basic';
  planPill.innerHTML = `Plan: <strong>${planName}</strong>`;
  if (plan === 'unlimited') revPill.style.display = 'inline-block';

  function setStatus(msg, cls) {
    statusEl.textContent = msg || '';
    statusEl.className = `status ${cls || ''}`;
  }

  async function callGenerate(payload) {
    let res, data;

    try {
      res = await fetch('/.netlify/functions/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
    } catch (err) {
      setStatus('Network error: ' + err.message, 'err');
      alert('Network error: ' + err.message);
      return null;
    }

    try {
      data = await res.json();
    } catch {
      setStatus('Server returned a non-JSON response.', 'err');
      alert('Server returned a non-JSON response.');
      return null;
    }

    if (!res.ok || !data.ok) {
      const msg = data?.error || `${res.status} ${res.statusText}`;
      setStatus('OpenAI error: ' + msg, 'err');
      alert('OpenAI error: ' + msg);
      return null;
    }

    return data; // { ok: true, text: '...' }
  }

  generateBtn.addEventListener('click', async (e) => {
    e.preventDefault();

    const payload = {
      plan,
      message_for: document.getElementById('message_for').value.trim(),
      goal: document.getElementById('goal').value.trim(),
      what_to_say: document.getElementById('what_to_say').value.trim(),
      tone: document.getElementById('tone').value,
      revision_note: document.getElementById('revision_note').value.trim(),
    };

    if (!payload.message_for || !payload.goal || !payload.what_to_say) {
      setStatus('Please fill in all required fields.', 'err');
      alert('Please fill in: who the message is for, your goal, and what you want to say.');
      return;
    }

    generateBtn.disabled = true;
    const old = generateBtn.textContent;
    generateBtn.textContent = 'Working…';
    setStatus('');

    const data = await callGenerate(payload);

    if (data?.text) {
      outEl.value = data.text;
      setStatus('Done ✔', 'ok');
    }

    generateBtn.textContent = old;
    generateBtn.disabled = false;
  });

  copyBtn.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(outEl.value || '');
      const old = copyBtn.textContent;
      copyBtn.textContent = 'Copied!';
      setTimeout(() => copyBtn.textContent = old, 1200);
    } catch (e) {
      alert('Could not copy to clipboard.');
    }
  });
</script>
</body>
</html>
