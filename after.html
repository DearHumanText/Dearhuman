<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DearHuman — Your Message</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
  <style>
    :root { --bg:#0e1117; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --accent:#60a5fa; }
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    main{max-width:860px;margin:48px auto;padding:24px}
    .badge{display:inline-block;background:#1f2937;border:1px solid #2b3648;border-radius:999px;padding:6px 12px;font-size:12px;color:#cbd5e1;margin-bottom:10px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{margin:0 0 8px}
    p.muted{color:var(--muted);margin:0 0 18px}
    label{display:block;font-weight:600;margin:10px 0 6px}
    input,select,textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #203047;background:#0c1220;color:var(--text);outline:none}
    input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(96,165,250,.2)}
    textarea{min-height:120px;resize:vertical}
    .row{display:flex;gap:12px} .row .col{flex:1}
    .actions{margin-top:16px;display:flex;gap:10px;flex-wrap:wrap}
    button{appearance:none;border:0;border-radius:12px;padding:12px 16px;background:var(--accent);color:#0a101b;font-weight:700;cursor:pointer}
    button.secondary{background:#303a49;color:#e5e7eb}
    pre.output{white-space:pre-wrap;background:#0b1220;border:1px solid #1f2a40;border-radius:12px;padding:16px;margin-top:16px}
    .hidden{display:none!important}
  </style>
</head>
<body>
  <main>
    <div class="card">
      <span id="planBadge" class="badge"></span>
      <h1>Tell us the details</h1>
      <p class="muted">We’ll generate your message instantly based on your plan.</p>

      <form id="genForm">
        <input type="hidden" id="plan" name="plan" value="">
        <div class="row">
          <div class="col">
            <label for="message_for">Who is this message for?</label>
            <input id="message_for" name="message_for" placeholder="e.g., my ex, my manager, my friend" required>
          </div>
          <div class="col">
            <label for="tone">Tone</label>
            <select id="tone" name="tone" required>
              <option value="Compassionate">Compassionate</option>
              <option value="Direct">Direct</option>
              <option value="Friendly">Friendly</option>
              <option value="Professional">Professional</option>
              <option value="Apologetic">Apologetic</option>
            </select>
          </div>
        </div>

        <label for="goal">What outcome are you hoping for?</label>
        <input id="goal" name="goal" placeholder="e.g., reconnect, apologize, set a boundary" required>

        <label for="what_to_say">What do you want to say?</label>
        <textarea id="what_to_say" name="what_to_say" placeholder="Give context. What happened? What do you want to express?" required></textarea>

        <div id="revBox" class="hidden">
          <label for="revision_note">Revision note (optional)</label>
          <input id="revision_note" name="revision_note" placeholder="What should we change or emphasize?">
        </div>

        <div class="actions">
          <button type="submit" id="generateBtn">Generate</button>
          <button type="button" id="reviseBtn" class="secondary hidden">Request revision</button>
          <button type="button" id="copyBtn" class="secondary hidden">Copy</button>
        </div>
      </form>

      <pre id="output" class="output hidden"></pre>
      <p id="revInfo" class="muted hidden"></p>
    </div>
  </main>

  <script>
    const qp = new URLSearchParams(location.search);
    const plan = (qp.get('plan') || 'basic').toLowerCase();
    document.getElementById('plan').value = plan;

    const planBadge = document.getElementById('planBadge');
    const reviseBtn = document.getElementById('reviseBtn');
    const revBox = document.getElementById('revBox');
    const revInfo = document.getElementById('revInfo');
    let revisionsUsed = 0, revisionLimit = 0;

    if (plan === 'basic') { planBadge.textContent = 'Plan: Basic — Instant answer'; revisionLimit = 0; }
    else if (plan === 'premium') { planBadge.textContent = 'Plan: Premium — 1 revision'; revisionLimit = 1; }
    else { planBadge.textContent = 'Plan: Unlimited — unlimited revisions'; revisionLimit = Infinity; }

    if (revisionLimit > 0) {
      revBox.classList.remove('hidden');
      revInfo.classList.remove('hidden');
      revInfo.textContent = plan === 'premium'
        ? 'You can request 1 revision after the first draft.'
        : 'You can request unlimited revisions.';
    }

    const form = document.getElementById('genForm');
    const output = document.getElementById('output');
    const copyBtn = document.getElementById('copyBtn');
    const generateBtn = document.getElementById('generateBtn');

    async function callGenerate(payload) {
      const r = await fetch('/.netlify/functions/generate', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await r.json();
      if (!r.ok) throw new Error(data.error || 'Failed to generate');
      return data.answer;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      generateBtn.disabled = true; generateBtn.textContent = 'Working…';
      try {
        const payload = Object.fromEntries(new FormData(form).entries());
        const answer = await callGenerate(payload);
        output.textContent = answer;
        output.classList.remove('hidden');
        copyBtn.classList.remove('hidden');
        if (revisionLimit > 0) reviseBtn.classList.remove('hidden');
      } catch (err) {
        alert(err.message || err);
      } finally {
        generateBtn.disabled = false; generateBtn.textContent = 'Generate';
      }
    });

    reviseBtn.addEventListener('click', async () => {
      if (revisionsUsed >= revisionLimit) return alert('Revision limit reached for your plan.');
      const payload = Object.fromEntries(new FormData(form).entries());
      if (!payload.revision_note) return alert('Please add a revision note (what should change?).');
      reviseBtn.disabled = true; reviseBtn.textContent = 'Revising…';
      try {
        const answer = await callGenerate(payload);
        output.textContent = answer;
        revisionsUsed += 1;
        if (revisionsUsed >= revisionLimit && revisionLimit !== Infinity) {
          reviseBtn.classList.add('hidden');
          revInfo.textContent = 'Revision used (1/1).';
        } else if (revisionLimit === Infinity) {
          revInfo.textContent = `Revisions used: ${revisionsUsed}`;
        }
      } catch (err) {
        alert(err.message || err);
      } finally {
        reviseBtn.disabled = false; reviseBtn.textContent = 'Request revision';
      }
    });

    copyBtn.addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(output.textContent); copyBtn.textContent = 'Copied!'; setTimeout(()=>copyBtn.textContent='Copy',1000); } catch {}
    });
  </script>
</body>
</html>
