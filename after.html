<!doctype html>
<button type="button" id="regenBtn" class="btn btn-secondary">Regenerate</button>
<span class="tiny">Unlimited regenerates included.</span>
</div>
<div class="tiny" style="margin-top:6px">We don’t store your message.</div>
</form>


<div id="result" class="out" style="display:none"></div>
</div>
</main>


<script>
// Track real purchases (Gumroad appends sale_id/purchase_id when redirecting)
const params = new URLSearchParams(location.search);
if ((params.get('sale_id') || params.get('purchase_id')) && window.plausible) {
plausible('purchase', { props: { tier: 'unlimited' } });
}


// Stable client token (for future features/analytics)
let clientToken = localStorage.getItem('dh.client');
if (!clientToken) {
clientToken = (crypto.randomUUID && crypto.randomUUID()) || Math.random().toString(36).slice(2);
localStorage.setItem('dh.client', clientToken);
}


const result = document.getElementById('result');
const form = document.getElementById('msgForm');
const generateBtn = document.getElementById('generateBtn');
const regenBtn = document.getElementById('regenBtn');


async function callGenerate(isRegen){
generateBtn.disabled = true; regenBtn.disabled = true;
generateBtn.textContent = isRegen ? 'Regenerating…' : 'Generating…';


const payload = {
tier: 'unlimited',
messageType: document.getElementById('messageType').value,
tone: document.getElementById('tone').value,
recipient: document.getElementById('recipient').value,
say: document.getElementById('say').value,
context: document.getElementById('context').value,
clientToken
};


try {
const res = await fetch('/.netlify/functions/generate', {
method:'POST', headers:{'Content-Type':'application/json'},
body: JSON.stringify(payload)
});
const data = await res.json();
result.style.display = 'block';
result.textContent = data.message || data.text || 'Success, but no text returned.';
window.plausible && plausible(isRegen ? 'regen' : 'generate', { props: { tier: 'unlimited' } });
} catch (e) {
console.error(e);
alert('Something went wrong generating your message.');
} finally {
generateBtn.textContent = 'Generate';
generateBtn.disabled = false; regenBtn.disabled = false;
}
}


form.addEventListener('submit', (e)=>{ e.preventDefault(); callGenerate(false); });
regenBtn.addEventListener('click', ()=> callGenerate(true));
</script>
</body>
</html>