<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Your DearHuman Message</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#f7f7fb; color:#222; margin:0; padding:24px; }
    .card { max-width: 800px; margin: 0 auto; background:#fff; border-radius:16px; padding:24px; box-shadow: 0 8px 24px rgba(0,0,0,0.08); }
    .title { font-size: 22px; font-weight: 700; margin-bottom: 6px; }
    .sub { color:#666; margin-bottom: 20px; }
    .msg { white-space: pre-wrap; line-height:1.6; font-size: 16px; background:#fafafa; border:1px solid #eee; border-radius:12px; padding:16px; min-height: 160px; }
    .row { display:flex; gap:12px; margin-top:16px; flex-wrap: wrap; }
    button { padding:10px 14px; border-radius:10px; border:1px solid #ddd; background:#fafafa; cursor:pointer; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
  </style>
</head>
<body>
  <div class="card">
    <div class="title">Your message is ready</div>
    <div class="sub">Copy, download, or regenerate if your plan allows.</div>
    <div id="out" class="msg">Generating your message...</div>
    <div class="row">
      <button id="copy">Copy</button>
      <button id="download">Download</button>
      <button id="regen">Regenerate</button>
    </div>
  </div>

  <script>
    async function pollResult(saleId){
      const r = await fetch(`/.netlify/functions/result?sale_id=${encodeURIComponent(saleId)}`);
      return r.json();
    }
    function downloadText(filename, text) {
      const a = document.createElement('a');
      const file = new Blob([text], { type: 'text/plain' });
      a.href = URL.createObjectURL(file);
      a.download = filename;
      a.click();
    }

    (async () => {
      const params = new URLSearchParams(location.search);
      const saleId = params.get('sale_id');
      const out = document.getElementById('out');
      const regenBtn = document.getElementById('regen');
      const copyBtn = document.getElementById('copy');
      const dlBtn = document.getElementById('download');

      if (!saleId) { out.textContent = 'Missing purchase ID.'; return; }

      // poll until ready
      let data;
      out.textContent = 'Generating your message...';
      for (let i=0; i<40; i++){
        data = await pollResult(saleId);
        if (data.status === 'ready') break;
        await new Promise(res => setTimeout(res, 1500));
      }
      if (data.status !== 'ready') { out.textContent = 'Still working â€” refresh in a moment.'; return; }

      out.textContent = data.message;

      // Copy
      copyBtn.onclick = () => navigator.clipboard.writeText(data.message);

      // Download
      dlBtn.onclick = () => downloadText('dearhuman.txt', data.message);

      // Regenerate (future step)
      function updateRegenBtn() {
        regenBtn.disabled = (data.plan !== 'unlimited' && data.remaining_regens <= 0);
        regenBtn.textContent = regenBtn.disabled ? 'No regenerations left' : 'Regenerate';
      }
      updateRegenBtn();

      regenBtn.onclick = async () => {
        const r = await fetch('/.netlify/functions/regenerate', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ sale_id: saleId })
        });
        const nxt = await r.json();
        if (nxt.error) return;
        data = nxt; out.textContent = data.message; updateRegenBtn();
      };
    })();
  </script>
</body>
</html>
